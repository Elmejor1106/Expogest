<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Solicitudes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid;
        }
        .timeline-item.pendiente::before { border-color: #ffc107; }
        .timeline-item.aprobada::before { border-color: #28a745; }
        .timeline-item.rechazada::before { border-color: #dc3545; }
        .timeline-item.cancelada::before { border-color: #6c757d; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-earmark-person"></i> Mis Solicitudes de Stand</h2>
        <div>
            <a th:href="@{/eventos}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Nueva Solicitud
            </a>
            <a th:href="@{/panelExpositor}" class="btn btn-outline-primary">
                <i class="bi bi-house"></i> Mi Panel
            </a>
        </div>
    </div>

    <!-- Mensajes -->
    <div th:if="${mensaje}" th:class="'alert alert-' + ${tipo} + ' alert-dismissible fade show'" role="alert">
        <span th:text="${mensaje}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Resumen de Estado -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-warning shadow-sm">
                <div class="card-body">
                    <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                    <h6 class="mt-2">Pendientes</h6>
                    <h3 th:text="${#lists.size(#lists.toList(solicitudes.?[estado.toString() == 'PENDIENTE']))}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success shadow-sm">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    <h6 class="mt-2">Aprobadas</h6>
                    <h3 th:text="${#lists.size(#lists.toList(solicitudes.?[estado.toString() == 'APROBADA']))}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger shadow-sm">
                <div class="card-body">
                    <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                    <h6 class="mt-2">Rechazadas</h6>
                    <h3 th:text="${#lists.size(#lists.toList(solicitudes.?[estado.toString() == 'RECHAZADA']))}">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-secondary shadow-sm">
                <div class="card-body">
                    <i class="bi bi-dash-circle text-secondary" style="font-size: 2rem;"></i>
                    <h6 class="mt-2">Canceladas</h6>
                    <h3 th:text="${#lists.size(#lists.toList(solicitudes.?[estado.toString() == 'CANCELADA']))}">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Solicitudes -->
    <div th:if="${solicitudes.empty}" class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 5rem; color: #ccc;"></i>
        <h3 class="mt-3 text-muted">No tienes solicitudes</h3>
        <p class="text-muted">Comienza solicitando un stand para un evento activo</p>
        <a th:href="@{/eventos}" class="btn btn-primary btn-lg mt-3">
            <i class="bi bi-search"></i> Ver Eventos Disponibles
        </a>
    </div>

    <div class="row" th:unless="${solicitudes.empty}">
        <div th:each="solicitud : ${solicitudes}" class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <!-- Header con estado -->
                <div class="card-header" 
                     th:classappend="${solicitud.estado.toString() == 'PENDIENTE'} ? 'bg-warning text-dark' : 
                                     (${solicitud.estado.toString() == 'APROBADA'} ? 'bg-success text-white' : 
                                     (${solicitud.estado.toString() == 'RECHAZADA'} ? 'bg-danger text-white' : 'bg-secondary text-white'))">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span th:switch="${solicitud.estado.toString()}">
                                <span th:case="'PENDIENTE'">
                                    <i class="bi bi-clock"></i> En Revisión
                                </span>
                                <span th:case="'APROBADA'">
                                    <i class="bi bi-check-circle"></i> Aprobada
                                </span>
                                <span th:case="'RECHAZADA'">
                                    <i class="bi bi-x-circle"></i> Rechazada
                                </span>
                                <span th:case="'CANCELADA'">
                                    <i class="bi bi-dash-circle"></i> Cancelada
                                </span>
                            </span>
                        </h5>
                        <small th:text="${#temporals.format(solicitud.fechaSolicitud, 'dd/MM/yyyy')}"></small>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Información básica -->
                    <div class="mb-3">
                        <h6 class="text-muted"><i class="bi bi-calendar-event"></i> Evento</h6>
                        <p><small th:text="${solicitud.eventoId}"></small></p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-muted"><i class="bi bi-shop"></i> Stand</h6>
                        <p><small th:text="${solicitud.standId}"></small></p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-muted"><i class="bi bi-file-text"></i> Descripción</h6>
                        <p class="text-justify" th:text="${solicitud.descripcion}"></p>
                    </div>

                    <!-- Timeline de fechas -->
                    <div class="timeline mt-4">
                        <div class="timeline-item" 
                             th:classappend="${solicitud.estado.toString().toLowerCase()}">
                            <strong>Solicitud enviada</strong><br>
                            <small class="text-muted" 
                                   th:text="${#temporals.format(solicitud.fechaSolicitud, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                        
                        <div th:if="${solicitud.fechaRespuesta}" 
                             class="timeline-item"
                             th:classappend="${solicitud.estado.toString().toLowerCase()}">
                            <strong th:text="${solicitud.estado.toString() == 'APROBADA'} ? 'Aprobada' : 'Rechazada'"></strong><br>
                            <small class="text-muted" 
                                   th:text="${#temporals.format(solicitud.fechaRespuesta, 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                    </div>

                    <!-- Motivo de rechazo -->
                    <div th:if="${solicitud.estado.toString() == 'RECHAZADA' and solicitud.motivoRechazo}" 
                         class="alert alert-danger mt-3">
                        <h6><i class="bi bi-info-circle"></i> Motivo del rechazo:</h6>
                        <p class="mb-0" th:text="${solicitud.motivoRechazo}"></p>
                    </div>

                    <!-- Mensaje de éxito -->
                    <div th:if="${solicitud.estado.toString() == 'APROBADA'}" 
                         class="alert alert-success mt-3">
                        <i class="bi bi-check-circle"></i>
                        <strong>¡Felicitaciones!</strong> Tu solicitud ha sido aprobada. 
                        El stand está asignado a tu empresa.
                    </div>
                </div>

                <!-- Acciones -->
                <div class="card-footer bg-light">
                    <div class="d-grid gap-2">
                        <!-- Cancelar (solo PENDIENTE) -->
                        <form th:if="${solicitud.estado.toString() == 'PENDIENTE'}" 
                              th:action="@{/solicitudes/{id}/cancelar(id=${solicitud.id})}" 
                              method="post">
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('¿Cancelar esta solicitud?\n\nNo podrás recuperarla.')">
                                <i class="bi bi-x-circle"></i> Cancelar Solicitud
                            </button>
                        </form>

                        <!-- Eliminar (solo RECHAZADA o CANCELADA) -->
                        <a th:if="${solicitud.estado.toString() == 'RECHAZADA' or solicitud.estado.toString() == 'CANCELADA'}" 
                           th:href="@{/solicitudes/{id}/eliminar(id=${solicitud.id})}" 
                           class="btn btn-outline-secondary w-100"
                           onclick="return confirm('¿Eliminar permanentemente esta solicitud del historial?')">
                            <i class="bi bi-trash"></i> Eliminar del Historial
                        </a>

                        <!-- Ver detalles técnicos -->
                        <button type="button" class="btn btn-sm btn-outline-info w-100" 
                                data-bs-toggle="collapse" 
                                th:data-bs-target="'#detalles' + ${solicitud.id}">
                            <i class="bi bi-code"></i> Detalles Técnicos
                        </button>
                    </div>

                    <!-- Detalles colapsables -->
                    <div th:id="'detalles' + ${solicitud.id}" class="collapse mt-3">
                        <div class="card card-body bg-white">
                            <small>
                                <strong>ID:</strong> <code th:text="${solicitud.id}"></code><br>
                                <strong>Expositor ID:</strong> <code th:text="${solicitud.expositorId}"></code><br>
                                <strong>Evento ID:</strong> <code th:text="${solicitud.eventoId}"></code><br>
                                <strong>Stand ID:</strong> <code th:text="${solicitud.standId}"></code><br>
                                <span th:if="${solicitud.organizadorId}">
                                    <strong>Revisado por:</strong> <code th:text="${solicitud.organizadorId}"></code><br>
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
